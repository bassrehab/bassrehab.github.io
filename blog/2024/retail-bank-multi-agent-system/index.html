<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="R3nPzqP9nO2aTgysGUiU3t-pw3wi1xuUuKVaMrimuck"> <meta name="msvalidate.01" content="04fec5e0d64b1c9bc788e98f81ee2a78"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Engineering Multi-Agent Systems - A Retail Banking Case Study | subhadip mitra </title> <meta name="author" content="Subhadip Mitra"> <meta name="description" content="Explore a detailed technical implementation of a multi-agent system for retail banking credit assessment. Learn about agent architecture, distributed systems patterns, error handling, compliance requirements, and performance optimization through actual code examples and system diagrams. Ideal for software architects and engineers building scalable financial systems."> <meta name="keywords" content="subhadip, subhadip mitra, subhadeep mitra, subhadip google, google, dikku, personal website, Data Analytics, Quantum Computing, Distributed Systems, Blockchain, Artificial Intelligence, Big Data, ETL Processes, Data Management, Open Source Projects, Technology Blogging, Software Engineering Insights, Data &amp; Analytics Trends, Personal Technology Musings, Approximate Calculations, Quantum Data Management, Real-Time Data Processing, Data Platform Innovations, Cloud Technologies, Machine Learning Models, Technology Consulting"> <meta property="og:site_name" content="subhadip mitra"> <meta property="og:type" content="article"> <meta property="og:title" content="subhadip mitra | Engineering Multi-Agent Systems - A Retail Banking Case Study"> <meta property="og:url" content="https://subhadipmitra.com/blog/2024/retail-bank-multi-agent-system/"> <meta property="og:description" content="Explore a detailed technical implementation of a multi-agent system for retail banking credit assessment. Learn about agent architecture, distributed systems patterns, error handling, compliance requirements, and performance optimization through actual code examples and system diagrams. Ideal for software architects and engineers building scalable financial systems."> <meta property="og:image" content="/assets/img/social_preview.png"> <meta property="og:locale" content="en"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Engineering Multi-Agent Systems - A Retail Banking Case Study"> <meta name="twitter:description" content="Explore a detailed technical implementation of a multi-agent system for retail banking credit assessment. Learn about agent architecture, distributed systems patterns, error handling, compliance requirements, and performance optimization through actual code examples and system diagrams. Ideal for software architects and engineers building scalable financial systems."> <meta name="twitter:image" content="/assets/img/social_preview.png"> <meta name="twitter:site" content="@bassrehab"> <meta name="twitter:creator" content="@bassrehab"> <script type="application/ld+json">
    {
        "author":
        {
            "@type": "Person",
            "name": "Subhadip Mitra"
        },
        "url": "https://subhadipmitra.com/blog/2024/retail-bank-multi-agent-system/",
        "@type": "BlogPosting",
        "description": "Explore a detailed technical implementation of a multi-agent system for retail banking credit assessment. Learn about agent architecture, distributed systems patterns, error handling, compliance requirements, and performance optimization through actual code examples and system diagrams. Ideal for software architects and engineers building scalable financial systems.",
        "headline": "Engineering Multi-Agent Systems - A Retail Banking Case Study",
        
        "sameAs": ["https://orcid.org/0000-0002-3977-7402", "https://www.researchgate.net/profile/Subhadip-Mitra-3", "https://github.com/bassrehab", "https://www.linkedin.com/in/subhadip-mitra", "https://twitter.com/bassrehab"],
        
        "name": "Subhadip Mitra",
        "@context": "https://schema.org"
    }
  </script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <script type="text/javascript">!function(t,e,n,a,c,s,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(a)).async=1,s.src="https://www.clarity.ms/tag/"+c,(r=e.getElementsByTagName(a)[0]).parentNode.insertBefore(s,r)}(window,document,"clarity","script","pas45gbkvm");</script> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="/assets/img/favicon.png?058310854f7b3c920f894a1d42c3c47b"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://subhadipmitra.com/blog/2024/retail-bank-multi-agent-system/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> subhadip mitra </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">more </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/search/">search</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/contact/">contact</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/license/">licenses</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/privacy/">privacy</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Engineering Multi-Agent Systems - A Retail Banking Case Study</h1> <p class="post-meta"> December 28, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/genai"> <i class="fa-solid fa-hashtag fa-sm"></i> genai</a>   <a href="/blog/tag/architecture"> <i class="fa-solid fa-hashtag fa-sm"></i> architecture</a>   <a href="/blog/tag/casestudy"> <i class="fa-solid fa-hashtag fa-sm"></i> casestudy</a>     ·   <a href="/blog/category/architecture"> <i class="fa-solid fa-tag fa-sm"></i> architecture</a>   <a href="/blog/category/genai"> <i class="fa-solid fa-tag fa-sm"></i> genai</a>   <a href="/blog/category/casetudy"> <i class="fa-solid fa-tag fa-sm"></i> casetudy</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Modern retail banking systems face complex challenges that demand sophisticated technical solutions. In this deep dive, we’ll explore how multi-agent architectures solve real problems in credit assessment systems, using a production-grade implementation as our guide.</p> <h2 id="the-credit-assessment-challenge">The Credit Assessment Challenge</h2> <p>A bank’s credit assessment system needs to:</p> <ul> <li>Process thousands of applications simultaneously</li> <li>Integrate with multiple external systems</li> <li>Maintain strict compliance and audit trails</li> <li>Provide real-time decisions when possible</li> <li>Scale during high-demand periods (like tax season)</li> <li>Handle system failures gracefully</li> </ul> <p>Traditional monolithic architectures struggle with these requirements. Let’s explore how a multi-agent system addresses these challenges.</p> <h2 id="system-architecture">System Architecture</h2> <p>Our credit assessment system uses specialized agents that each handle specific aspects of the loan application process:</p> <p><img src="/assets/img/blog/agents-fsi-system-architecture.png" alt="Reference system architecture"></p> <h3 id="key-components">Key Components</h3> <ol> <li>Income Verification Agent <ul> <li>Processes bank statements and pay stubs</li> <li>Verifies employment information</li> <li>Calculates income stability metrics</li> </ul> </li> <li>Credit Bureau Agent <ul> <li>Manages rate-limited API access to credit bureaus</li> <li>Normalizes data from multiple bureaus</li> <li>Maintains score history and change tracking</li> </ul> </li> <li>Fraud Detection Agent <ul> <li>Runs ML models for fraud detection</li> <li>Performs velocity checks</li> <li>Manages investigation workflows</li> </ul> </li> <li>Risk Assessment Agent <ul> <li>Calculates debt-to-income ratios</li> <li>Evaluates borrower risk profiles</li> <li>Applies regulatory rules</li> </ul> </li> </ol> <h2 id="implementation-deep-dive">Implementation Deep Dive</h2> <p>Let’s examine how these components work together in practice.</p> <h3 id="application-flow">Application Flow</h3> <p>The diagram below shows how a typical application flows through the system:</p> <p><img src="/assets/img/blog/credit-assessment-process-flow.png" alt="Reference credit-flow artifact"></p> <h3 id="code-implementation">Code Implementation</h3> <p>The heart of our system is the <code class="language-plaintext highlighter-rouge">CreditAssessmentOrchestrator</code>. Here’s how it processes applications:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">process_application</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">application</span><span class="p">:</span> <span class="n">LoanApplication</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CreditDecision</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start timing for SLA tracking
</span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        
        <span class="c1"># Step 1: Verify Income
</span>        <span class="n">income_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">income_agent</span><span class="p">.</span><span class="nf">verify_income</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
        
        <span class="c1"># Quick fail if income is insufficient
</span>        <span class="k">if</span> <span class="n">income_data</span><span class="p">[</span><span class="sh">"</span><span class="s">monthly_income</span><span class="sh">"</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">&lt;</span> \
           <span class="n">self</span><span class="p">.</span><span class="nf">_calculate_monthly_payment</span><span class="p">(</span><span class="n">application</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CreditDecision</span><span class="p">.</span><span class="n">DECLINED</span>
</code></pre></div></div> <p>This code demonstrates several key patterns:</p> <ul> <li>Async processing for improved throughput</li> <li>Early rejection for obvious failures</li> <li>SLA monitoring</li> <li>Structured error handling</li> </ul> <h3 id="state-management">State Management</h3> <p>State management is crucial in credit assessment. Our <code class="language-plaintext highlighter-rouge">IncomeVerificationAgent</code> shows how to handle this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">verify_income</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">application</span><span class="p">:</span> <span class="n">LoanApplication</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">income::</span><span class="si">{</span><span class="n">application</span><span class="p">.</span><span class="n">customer_id</span><span class="si">}</span><span class="sh">"</span>
    
    <span class="c1"># Check cache first
</span>    <span class="n">cached</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
</code></pre></div></div> <p>This implementation:</p> <ul> <li>Uses Redis for distributed caching</li> <li>Implements TTL for regulatory compliance</li> <li>Maintains audit trails</li> <li>Handles race conditions</li> </ul> <h2 id="production-considerations">Production Considerations</h2> <h3 id="scaling-characteristics">Scaling Characteristics</h3> <p>Our production system handles varying load profiles:</p> <ul> <li>Normal operation: 100-200 applications/minute</li> <li>Peak periods (tax season): 500-600 applications/minute</li> <li>Batch processing: Up to 10,000 applications/hour</li> </ul> <p>Key scaling strategies:</p> <ol> <li>Horizontal scaling of stateless agents</li> <li>Redis cluster for state management</li> <li>Partitioned queues for better throughput</li> <li>Read replicas for reporting queries</li> </ol> <h3 id="performance-optimizations">Performance Optimizations</h3> <p>Real-world performance improvements implemented:</p> <ol> <li>Smart Batching <ul> <li>Group credit bureau checks by provider</li> <li>Batch document processing jobs</li> <li>Combine similar ML model inferences</li> </ul> </li> <li>Caching Strategy <ul> <li>Cache income verification results (1-hour TTL)</li> <li>Cache credit scores (24-hour TTL)</li> <li>No caching of fraud checks (real-time requirement)</li> </ul> </li> <li>Resource Management <ul> <li>Connection pooling for external APIs</li> <li>Managed thread pools for CPU-intensive tasks</li> <li>Rate limiting for external service calls</li> <li>Dynamic queue sizing based on load</li> </ul> </li> </ol> <h3 id="error-handling-in-production">Error Handling in Production</h3> <p><img src="/assets/img/blog/credit-system-failure-handling.png" alt="Reference credits system failure handling"></p> <p>When dealing with financial transactions, error handling becomes critical. Our system implements several layers of protection:</p> <ol> <li>Circuit Breakers <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreditBureauService</span><span class="p">:</span>
 <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
     <span class="n">self</span><span class="p">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>
     <span class="n">self</span><span class="p">.</span><span class="n">last_failure</span> <span class="o">=</span> <span class="bp">None</span>
     <span class="n">self</span><span class="p">.</span><span class="n">circuit_open</span> <span class="o">=</span> <span class="bp">False</span>
        
 <span class="k">async</span> <span class="k">def</span> <span class="nf">check_credit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">circuit_open</span><span class="p">:</span>
         <span class="nf">if </span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">last_failure</span><span class="p">).</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
             <span class="k">raise</span> <span class="nc">CircuitBreakerError</span><span class="p">(</span><span class="sh">"</span><span class="s">Credit bureau service unavailable</span><span class="sh">"</span><span class="p">)</span>
         <span class="n">self</span><span class="p">.</span><span class="n">circuit_open</span> <span class="o">=</span> <span class="bp">False</span>
            
     <span class="k">try</span><span class="p">:</span>
         <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_bureau_call</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
     <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">self</span><span class="p">.</span><span class="n">failure_count</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="n">self</span><span class="p">.</span><span class="n">last_failure</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">failure_count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
             <span class="n">self</span><span class="p">.</span><span class="n">circuit_open</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="k">raise</span>
</code></pre></div> </div> </li> <li>Retry Mechanisms <ul> <li>Exponential backoff for transient failures</li> <li>Different strategies for different error types: <ul> <li>Retry immediately for timeouts</li> <li>Delay for rate limiting</li> <li>No retry for validation errors</li> </ul> </li> </ul> </li> <li>Dead Letter Queues <ul> <li>Failed applications are moved to analysis queues</li> <li>Automated recovery for known error patterns</li> <li>Manual review triggers for unknown failures</li> </ul> </li> </ol> <h2 id="compliance-and-audit-requirements">Compliance and Audit Requirements</h2> <p>Financial systems require stringent compliance measures. Our architecture addresses these through:</p> <h3 id="1-comprehensive-logging">1. Comprehensive Logging</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AuditLog</span><span class="p">:</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">application_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="n">output_data</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="n">processing_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">error_details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">AuditLogger</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">log_action</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> 
                        <span class="n">application</span><span class="p">:</span> <span class="n">LoanApplication</span><span class="p">,</span>
                        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                        <span class="n">output_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                        <span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="nc">AuditLog</span><span class="p">(</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">(),</span>
            <span class="n">application_id</span><span class="o">=</span><span class="n">application</span><span class="p">.</span><span class="n">application_id</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">agent_id</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">,</span>
            <span class="n">output_data</span><span class="o">=</span><span class="n">output_data</span><span class="p">,</span>
            <span class="n">processing_time</span><span class="o">=</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">error_details</span><span class="o">=</span><span class="nf">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_persist_log</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span>
</code></pre></div></div> <h3 id="2-data-retention">2. Data Retention</h3> <ul> <li>Configurable retention periods by data type</li> <li>Automated archival processes</li> <li>Secure data disposal workflows</li> </ul> <h3 id="3-access-controls">3. Access Controls</h3> <ul> <li>Role-based access for different agent types</li> <li>Audit trails for all data access</li> <li>Encryption for sensitive data fields</li> </ul> <h2 id="monitoring-and-observability">Monitoring and Observability</h2> <p>In production, visibility into system behavior is crucial. Our monitoring setup includes:</p> <ol> <li>Business Metrics <ul> <li>Application approval rates</li> <li>Average decision time</li> <li>Agent processing rates</li> <li>Queue depths</li> </ul> </li> <li>Technical Metrics <ul> <li>External API latencies</li> <li>Cache hit rates</li> <li>Database IOPS</li> <li>Memory utilization</li> </ul> </li> <li>Alerting Rules <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MetricsCollector</span><span class="p">:</span>
 <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
     <span class="n">self</span><span class="p">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        
 <span class="k">async</span> <span class="k">def</span> <span class="nf">track_decision_time</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
     <span class="n">processing_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">).</span><span class="nf">total_seconds</span><span class="p">()</span>
     <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">push_metric</span><span class="p">(</span><span class="sh">'</span><span class="s">decision_time</span><span class="sh">'</span><span class="p">,</span> <span class="n">processing_time</span><span class="p">)</span>
        
     <span class="k">if</span> <span class="n">processing_time</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>  <span class="c1"># SLA threshold
</span>         <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">alert_slow_processing</span><span class="p">(</span><span class="n">processing_time</span><span class="p">)</span>
</code></pre></div> </div> </li> </ol> <h2 id="performance-testing-and-benchmarking">Performance Testing and Benchmarking</h2> <p>Before deploying our multi-agent credit assessment system, we conducted extensive performance testing. Here’s what we learned:</p> <h3 id="load-testing-results">Load Testing Results</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PerformanceTester</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_load_test</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">concurrent_users</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">async</span> <span class="k">def</span> <span class="nf">simulate_user</span><span class="p">():</span>
            <span class="k">while</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">duration_seconds</span><span class="p">:</span>
                <span class="n">application</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">generate_test_application</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
                    <span class="n">decision</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">orchestrator</span><span class="p">.</span><span class="nf">process_application</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
                    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
                    <span class="n">test_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">'</span><span class="s">success</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">latency</span><span class="sh">'</span><span class="p">:</span> <span class="n">elapsed</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">decision</span><span class="sh">'</span><span class="p">:</span> <span class="n">decision</span>
                    <span class="p">})</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">test_results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">'</span><span class="s">success</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">})</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        
        <span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="nf">simulate_user</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">concurrent_users</span><span class="p">)]</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="n">users</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">analyze_results</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>
</code></pre></div></div> <p>Key findings from our load tests:</p> <ol> <li>Throughput Characteristics <ul> <li>Baseline: 100 requests/second with 95th percentile latency &lt; 500ms</li> <li>Max throughput: 350 requests/second before degradation</li> <li>Memory usage grows linearly until 250 requests/second</li> <li>Redis becomes bottleneck at 400 requests/second</li> </ul> </li> <li>Latency Breakdown <ul> <li>Credit bureau API: 35% of total latency</li> <li>Document processing: 25% of total latency</li> <li>Fraud detection: 20% of total latency</li> <li>Database operations: 15% of total latency</li> <li>Other operations: 5% of total latency</li> </ul> </li> </ol> <h3 id="bottleneck-analysis">Bottleneck Analysis</h3> <p>We identified several bottlenecks during testing:</p> <ol> <li>Document Processing Agent <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DocumentProcessingOptimization</span><span class="p">:</span>
 <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
     <span class="n">self</span><span class="p">.</span><span class="n">thread_pool</span> <span class="o">=</span> <span class="nc">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="nf">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">10</span>
     <span class="n">self</span><span class="p">.</span><span class="n">processing_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Queue</span><span class="p">()</span>
    
 <span class="k">async</span> <span class="k">def</span> <span class="nf">process_documents</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
     <span class="c1"># Batch documents for efficient processing
</span>     <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">documents</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">]</span> 
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">documents</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">)]</span>
        
     <span class="k">async</span> <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="c1"># Use thread pool for CPU-intensive OCR
</span>             <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">run_in_executor</span><span class="p">(</span>
                 <span class="n">self</span><span class="p">.</span><span class="n">thread_pool</span><span class="p">,</span>
                 <span class="n">self</span><span class="p">.</span><span class="n">_process_batch</span><span class="p">,</span>
                 <span class="n">batch</span>
             <span class="p">)</span>
             <span class="k">return</span> <span class="n">results</span>
         <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Batch processing failed: </span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
             <span class="k">raise</span>
        
     <span class="c1"># Process batches concurrently
</span>     <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="nf">process_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">]</span>
     <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
</code></pre></div> </div> </li> <li>Credit Bureau Integration <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreditBureauOptimization</span><span class="p">:</span>
 <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
     <span class="n">self</span><span class="p">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="nc">AsyncRateLimiter</span><span class="p">(</span>
         <span class="n">rate</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># requests per second
</span>         <span class="n">burst</span><span class="o">=</span><span class="mi">20</span>   <span class="c1"># burst capacity
</span>     <span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nc">TTLCache</span><span class="p">(</span>
         <span class="n">maxsize</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
         <span class="n">ttl</span><span class="o">=</span><span class="mi">86400</span>  <span class="c1"># 24 hours
</span>     <span class="p">)</span>
    
 <span class="k">async</span> <span class="k">def</span> <span class="nf">get_credit_report</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
     <span class="c1"># Check cache first
</span>     <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">credit_report:</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="sh">"</span>
     <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
        
     <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">rate_limiter</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="n">report</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_credit_report</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
             <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span>
             <span class="k">return</span> <span class="n">report</span>
         <span class="k">except</span> <span class="n">RateLimitExceeded</span><span class="p">:</span>
             <span class="c1"># Implement fallback strategy
</span>             <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_fallback_credit_data</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
</code></pre></div> </div> </li> </ol> <h3 id="memory-profiling">Memory Profiling</h3> <p>We used memory profiling to optimize agent resource usage:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MemoryOptimizedAgent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">object_pool</span> <span class="o">=</span> <span class="nc">ObjectPool</span><span class="p">(</span>
            <span class="n">max_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">cleanup_interval</span><span class="o">=</span><span class="mi">300</span>
        <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">process_large_document</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">object_pool</span><span class="p">.</span><span class="nf">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">processor</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Process document with pooled resources
</span>                <span class="k">return</span> <span class="k">await</span> <span class="n">processor</span><span class="p">.</span><span class="nf">process</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Ensure cleanup of large objects
</span>                <span class="k">await</span> <span class="n">processor</span><span class="p">.</span><span class="nf">cleanup</span><span class="p">()</span>

<span class="nd">@memory_profile</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">profile_agent_memory</span><span class="p">():</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="nc">MemoryOptimizedAgent</span><span class="p">()</span>
    <span class="n">large_docs</span> <span class="o">=</span> <span class="nf">generate_test_documents</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    
    <span class="c1"># Monitor memory usage during processing
</span>    <span class="n">memory_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">large_docs</span><span class="p">:</span>
        <span class="n">mem_before</span> <span class="o">=</span> <span class="nf">get_memory_usage</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">agent</span><span class="p">.</span><span class="nf">process_large_document</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="n">mem_after</span> <span class="o">=</span> <span class="nf">get_memory_usage</span><span class="p">()</span>
        <span class="n">memory_samples</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">mem_after</span> <span class="o">-</span> <span class="n">mem_before</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nf">analyze_memory_pattern</span><span class="p">(</span><span class="n">memory_samples</span><span class="p">)</span>
</code></pre></div></div> <h3 id="database-optimization">Database Optimization</h3> <p>We optimized database access patterns:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DatabaseOptimization</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool</span> <span class="o">=</span> <span class="nc">ConnectionPool</span><span class="p">(</span>
            <span class="n">min_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">max_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">cleanup_timeout</span><span class="o">=</span><span class="mi">60</span>
        <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">bulk_insert_applications</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">applications</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Application</span><span class="p">]):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="nf">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">conn</span><span class="p">.</span><span class="nf">transaction</span><span class="p">():</span>
                <span class="c1"># Use COPY command for efficient bulk insert
</span>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">copy_records_to_table</span><span class="p">(</span>
                    <span class="sh">'</span><span class="s">applications</span><span class="sh">'</span><span class="p">,</span>
                    <span class="n">records</span><span class="o">=</span><span class="p">[</span><span class="n">app</span><span class="p">.</span><span class="nf">to_record</span><span class="p">()</span> <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">applications</span><span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">customer_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
                
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_application_batch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="nf">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c1"># Use cursor-based pagination
</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="sh">"""</span><span class="s">
                SELECT * FROM applications 
                WHERE status = </span><span class="sh">'</span><span class="s">pending</span><span class="sh">'</span><span class="s">
                ORDER BY submitted_at
                LIMIT $1
            </span><span class="sh">"""</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</code></pre></div></div> <h2 id="agent-communication-patterns">Agent Communication Patterns</h2> <p>Understanding how agents communicate effectively is crucial for system reliability. Let’s explore the key communication patterns we’ve implemented:</p> <h3 id="1-event-based-communication">1. Event-Based Communication</h3> <p>We use a message broker for asynchronous communication between agents:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span> <span class="nc">EventType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">INCOME_VERIFIED</span> <span class="o">=</span> <span class="sh">"</span><span class="s">income_verified</span><span class="sh">"</span>
    <span class="n">FRAUD_DETECTED</span> <span class="o">=</span> <span class="sh">"</span><span class="s">fraud_detected</span><span class="sh">"</span>
    <span class="n">CREDIT_CHECKED</span> <span class="o">=</span> <span class="sh">"</span><span class="s">credit_checked</span><span class="sh">"</span>
    <span class="n">DOC_PROCESSED</span> <span class="o">=</span> <span class="sh">"</span><span class="s">doc_processed</span><span class="sh">"</span>
    <span class="n">APPLICATION_UPDATED</span> <span class="o">=</span> <span class="sh">"</span><span class="s">application_updated</span><span class="sh">"</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
    <span class="n">event_type</span><span class="p">:</span> <span class="n">EventType</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">application_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">correlation_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">producer</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1.0</span><span class="sh">"</span>
    <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">EventPublisher</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">:</span> <span class="n">aioredis</span><span class="p">.</span><span class="n">Redis</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
        <span class="n">self</span><span class="p">.</span><span class="n">event_validators</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">EventType</span><span class="p">.</span><span class="n">INCOME_VERIFIED</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_validate_income_event</span><span class="p">,</span>
            <span class="n">EventType</span><span class="p">.</span><span class="n">FRAUD_DETECTED</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_validate_fraud_event</span>
        <span class="p">}</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Version compatibility check
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_check_version_compatibility</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">VersionIncompatibleError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Event version </span><span class="si">{</span><span class="n">event</span><span class="p">.</span><span class="n">version</span><span class="si">}</span><span class="s"> not supported</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># Validate event structure
</span>            <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="n">event_type</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">event_validators</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">event_validators</span><span class="p">[</span><span class="n">event</span><span class="p">.</span><span class="n">event_type</span><span class="p">](</span><span class="n">event</span><span class="p">)</span>
            
            <span class="c1"># Publish event
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span>
                <span class="n">channel</span><span class="p">,</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">dataclasses</span><span class="p">.</span><span class="nf">asdict</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
            <span class="p">)</span>
            
            <span class="c1"># Store event for audit
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_store_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to publish event: </span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_store_event</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Store event in time-series database for audit</span><span class="sh">"""</span>
        <span class="n">event_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">event:</span><span class="si">{</span><span class="n">event</span><span class="p">.</span><span class="n">correlation_id</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">event</span><span class="p">.</span><span class="n">timestamp</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span>
            <span class="n">event_key</span><span class="p">,</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">dataclasses</span><span class="p">.</span><span class="nf">asdict</span><span class="p">(</span><span class="n">event</span><span class="p">)),</span>
            <span class="n">ex</span><span class="o">=</span><span class="mi">86400</span>  <span class="c1"># 24 hour retention
</span>        <span class="p">)</span>
</code></pre></div></div> <h3 id="2-request-response-pattern">2. Request-Response Pattern</h3> <p>For synchronous operations, we implement a request-response pattern with timeouts:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AgentCommunicator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pending_requests</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">async</span> <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">target_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                     <span class="n">request_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                     <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">())</span>
        
        <span class="c1"># Create future for response
</span>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pending_requests</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Send request
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_send_request</span><span class="p">(</span><span class="n">target_agent</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">request_type</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
            
            <span class="c1"># Wait for response with timeout
</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">timeout</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">pending_requests</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
            <span class="k">raise</span> <span class="nc">RequestTimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Request to </span><span class="si">{</span><span class="n">target_agent</span><span class="si">}</span><span class="s"> timed out</span><span class="sh">"</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">pending_requests</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
            <span class="k">raise</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">request_id</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pending_requests</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pending_requests</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">future</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
                <span class="n">future</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div> <h3 id="3-broadcast-patterns">3. Broadcast Patterns</h3> <p>For system-wide updates and status changes:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SystemBroadcaster</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">:</span> <span class="n">aioredis</span><span class="p">.</span><span class="n">Redis</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
        <span class="n">self</span><span class="p">.</span><span class="n">broadcast_channels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">system_status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">system:status</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">config_updates</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">system:config</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">agent_health</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">system:health</span><span class="sh">'</span>
        <span class="p">}</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">broadcast_status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">Broadcast system status to all agents</span><span class="sh">"""</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">broadcast_id</span><span class="sh">'</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">())</span>
        <span class="p">}</span>
        
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">broadcast_channels</span><span class="p">[</span><span class="sh">'</span><span class="s">system_status</span><span class="sh">'</span><span class="p">],</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">broadcast_config_update</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">Broadcast configuration changes</span><span class="sh">"""</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">broadcast_channels</span><span class="p">[</span><span class="sh">'</span><span class="s">config_updates</span><span class="sh">'</span><span class="p">],</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span>
                <span class="sh">'</span><span class="s">config</span><span class="sh">'</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="p">)</span>
</code></pre></div></div> <h3 id="4-subscription-management">4. Subscription Management</h3> <p>Handling agent subscriptions and message filtering:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MessageSubscriber</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">agent_id</span> <span class="o">=</span> <span class="n">agent_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">subscriptions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">async</span> <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                       <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                       <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Subscribe to a channel with optional message filters</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">filters</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">subscriptions</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Apply filters if any
</span>        <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filter_fn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">[</span><span class="n">channel</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nf">filter_fn</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
                    <span class="k">return</span>
        
        <span class="c1"># Handle message
</span>        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">channel</span><span class="p">](</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></div> <h3 id="5-ordered-message-delivery">5. Ordered Message Delivery</h3> <p>Ensuring correct message ordering when needed:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">OrderedMessageHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">message_queues</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Queue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sequence_numbers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_ordered_message</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">application_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                   <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                   <span class="n">message</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">Handle messages in sequence order for a given application</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">application_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">message_queues</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">message_queues</span><span class="p">[</span><span class="n">application_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Queue</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">sequence_numbers</span><span class="p">[</span><span class="n">application_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="n">current_seq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">sequence_numbers</span><span class="p">[</span><span class="n">application_id</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">==</span> <span class="n">current_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Process message immediately
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_process_message</span><span class="p">(</span><span class="n">application_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">sequence_numbers</span><span class="p">[</span><span class="n">application_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Process any queued messages
</span>            <span class="k">while</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">message_queues</span><span class="p">[</span><span class="n">application_id</span><span class="p">].</span><span class="nf">empty</span><span class="p">():</span>
                <span class="n">queued_seq</span><span class="p">,</span> <span class="n">queued_msg</span> <span class="o">=</span> \
                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">message_queues</span><span class="p">[</span><span class="n">application_id</span><span class="p">].</span><span class="nf">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">queued_seq</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">sequence_numbers</span><span class="p">[</span><span class="n">application_id</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_process_message</span><span class="p">(</span><span class="n">application_id</span><span class="p">,</span> <span class="n">queued_msg</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">sequence_numbers</span><span class="p">[</span><span class="n">application_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Put it back if it's not the next in sequence
</span>                    <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">message_queues</span><span class="p">[</span><span class="n">application_id</span><span class="p">].</span><span class="nf">put</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">queued_seq</span><span class="p">,</span> <span class="n">queued_msg</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Queue out-of-order message
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">message_queues</span><span class="p">[</span><span class="n">application_id</span><span class="p">].</span><span class="nf">put</span><span class="p">(</span>
                <span class="p">(</span><span class="n">sequence_number</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="p">)</span>
</code></pre></div></div> <h3 id="6-dead-letter-handling">6. Dead Letter Handling</h3> <p>Managing failed messages and retry logic:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DeadLetterQueue</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">:</span> <span class="n">aioredis</span><span class="p">.</span><span class="n">Redis</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">self</span><span class="p">.</span><span class="n">retry_delays</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">900</span><span class="p">]</span>  <span class="c1"># Progressive delays in seconds
</span>    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_failed_message</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
                                  <span class="n">error</span><span class="p">:</span> <span class="nb">Exception</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Handle failed message processing</span><span class="sh">"""</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">retry_count</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">max_retries</span><span class="p">:</span>
            <span class="c1"># Move to dead letter queue for manual review
</span>            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_move_to_dlq</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Schedule retry
</span>        <span class="n">delay</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">retry_delays</span><span class="p">[</span><span class="n">retry_count</span><span class="p">]</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_schedule_retry</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
        
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_schedule_retry</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Schedule message for retry after delay</span><span class="sh">"""</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">retry_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">retry_count</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">last_error_time</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        
        <span class="n">retry_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">delay</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">redis</span><span class="p">.</span><span class="nf">zadd</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">message:retry_queue</span><span class="sh">'</span><span class="p">,</span>
            <span class="p">{</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">):</span> <span class="n">retry_time</span><span class="p">}</span>
        <span class="p">)</span>
</code></pre></div></div> <p>These communication patterns form the backbone of our multi-agent system, ensuring reliable, ordered, and traceable message delivery between components. The implementation includes:</p> <ul> <li>Event validation and versioning</li> <li>Timeout handling and retries</li> <li>Message ordering guarantees</li> <li>Dead letter queuing</li> <li>Broadcast capabilities</li> <li>Subscription management</li> </ul> <p>Each pattern addresses specific needs in the credit assessment workflow while maintaining system reliability and traceability.</p> <ol> <li>Agent Design Principles <ul> <li>Start with coarse-grained agents and split as responsibilities become clearer</li> <li>Use feature flags to control agent behavior during testing</li> <li>Build comprehensive logging into each agent from the start</li> <li>Plan for version compatibility between agents</li> </ul> </li> <li>Testing Challenges <ul> <li>Simulating credit bureau responses requires extensive test data</li> <li>Fraud detection testing needs specialized synthetic data generation</li> <li>Integration testing requires careful orchestration of multiple external services</li> <li>Performance testing must account for variable API response times</li> </ul> </li> <li>Development Workflow <ul> <li>Use contract testing between agents</li> <li>Implement feature flags for gradual rollout capability</li> <li>Build comprehensive integration test suites</li> <li>Create detailed agent interaction documentation</li> </ul> </li> <li>Early Performance Findings <ul> <li>Document processing is more CPU-intensive than initially estimated</li> <li>Redis cache sizing needs careful consideration</li> <li>Credit bureau API quotas require sophisticated rate limiting</li> <li>Fraud check latency varies significantly by case complexity</li> </ul> </li> </ol> <h2 id="future-improvements">Future Improvements</h2> <p>Several enhancements are possible, some of them can be (perhaps, we will cover them in the next post):</p> <ol> <li>Machine Learning Integration <ul> <li>Real-time model retraining</li> <li>A/B testing framework</li> <li>Feature store integration</li> </ul> </li> <li>Scalability <ul> <li>Global deployment support</li> <li>Cross-region failover</li> <li>Enhanced load balancing</li> </ul> </li> <li>Developer Experience <ul> <li>Improved testing frameworks</li> <li>Better deployment automation</li> <li>Enhanced monitoring tools</li> </ul> </li> </ol> <h2 id="conclusion">Conclusion</h2> <p>Building a multi-agent system for credit assessment requires careful consideration of both technical and business requirements. The architecture presented here has proven robust in production, handling millions of credit applications while maintaining high availability and consistency.</p> <p>Remember that this implementation is specific to retail banking - your use case may require different trade-offs and design decisions. Focus on your specific requirements while borrowing the patterns that make sense for your context.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/genetic-algorithm-inspired-data-platforms-part-1/">Evolutionary Bytes - Harnessing Genetic Algorithms for Smarter Data Platforms (Part 1/2)</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/etlc-context-new-paradigm/">Introducing ETL-C (Extract, Transform, Load, Contextualize) - a new data processing paradigm</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/designing-a-real-time-data-processing-system/">Designing a Real Time Data Processing System</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/quantum-data-platform/">Data at Quantum Speed - The Promise and Potential of QDP</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/end-of-data-warehouses/">The End of Data Warehouses? Enter the Age of Dynamic Context Engines</a> </li> <div id="giscus_thread" style="max-width: 1024px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"bassrehab/bassrehab.github.io","data-repo-id":"R_kgDOLvY8Tg","data-category":"Comments","data-category-id":"DIC_kwDOLvY8Ts4CexzE","data-mapping":"title","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Subhadip Mitra. Some Rights Reserved. Last updated: January 06, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-TW7YQ5XPC6"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TW7YQ5XPC6");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>