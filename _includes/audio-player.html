{% if page.layout == 'post' or page.layout == 'distill' %}
<div class="audio-reader-container">
  <div class="audio-reader-compact">
    <button class="audio-trigger" id="audio-trigger" aria-label="Open audio player">
      <i class="fas fa-headphones"></i>
      <span>Listen to article</span>
      <i class="fas fa-chevron-down audio-trigger-icon"></i>
    </button>
    
    <div class="audio-player-expanded" id="audio-player-expanded">
      <div class="audio-player-body">
        <div class="audio-info-bar">
          <i class="fas fa-info-circle"></i>
          <span>Browser text-to-speech â€¢ Quality varies by device</span>
        </div>

        <div class="audio-controls-row">
          <button class="audio-btn audio-btn-play" id="tts-play" aria-label="Play">
            <i class="fas fa-play"></i>
            <span id="play-text">Play</span>
          </button>
          
          <button class="audio-btn audio-btn-pause" id="tts-pause" style="display: none;" aria-label="Pause">
            <i class="fas fa-pause"></i>
            <span>Pause</span>
          </button>
          
          <button class="audio-btn audio-btn-stop" id="tts-stop" aria-label="Stop">
            <i class="fas fa-stop"></i>
          </button>

          <div class="audio-speed-control">
            <label for="tts-rate" class="audio-speed-label">
              <i class="fas fa-gauge-high"></i>
              <span id="tts-rate-value">1.0x</span>
            </label>
            <input id="tts-rate" type="range" min="0.5" max="2" step="0.1" value="1" class="audio-speed-slider">
          </div>
        </div>

        <div class="audio-voice-row">
          <label for="tts-voice" class="audio-voice-label">
            <i class="fas fa-microphone"></i>
            <span>Voice:</span>
          </label>
          <select id="tts-voice" class="audio-voice-select">
            <option value="">Loading voices...</option>
          </select>
        </div>

        <div class="audio-progress-section">
          <div class="audio-progress-info">
            <span><i class="fas fa-circle-notch"></i> Progress</span>
            <span id="tts-progress">0%</span>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar" id="tts-progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.audio-reader-container {
  margin: 1.5rem 0;
  font-family: var(--global-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif);
}

.audio-reader-compact {
  position: relative;
}

/* Trigger Button - Sleek Design */
.audio-trigger {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--global-code-bg-color, #f8f9fa);
  border: 1px solid var(--global-divider-color, #dee2e6);
  border-radius: 0.375rem;
  color: var(--global-text-color, #212529);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}

.audio-trigger:hover {
  background: var(--global-bg-color, #ffffff);
  border-color: var(--global-theme-color, #0d6efd);
  color: var(--global-theme-color, #0d6efd);
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.audio-trigger i:first-child {
  font-size: 1rem;
  color: var(--global-theme-color, #0d6efd);
}

.audio-trigger-icon {
  font-size: 0.75rem;
  margin-left: 0.25rem;
  transition: transform 0.3s ease;
  color: var(--global-text-color-light, #6c757d);
}

.audio-trigger.active .audio-trigger-icon {
  transform: rotate(180deg);
}

.audio-trigger:focus {
  outline: 2px solid var(--global-theme-color, #0d6efd);
  outline-offset: 2px;
}

/* Expanded Player */
.audio-player-expanded {
  display: none;
  margin-top: 0.75rem;
  background: var(--global-bg-color, #ffffff);
  border: 1px solid var(--global-divider-color, #dee2e6);
  border-radius: 0.5rem;
  box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.05);
  animation: slideDown 0.3s ease;
}

.audio-player-expanded.show {
  display: block;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-0.5rem);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.audio-player-body {
  padding: 1rem;
}

/* Info Bar */
.audio-info-bar {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.625rem 0.75rem;
  background: var(--global-code-bg-color, #f8f9fa);
  border-left: 2px solid var(--global-theme-color, #0d6efd);
  border-radius: 0.25rem;
  font-size: 0.8125rem;
  color: var(--global-text-color-light, #6c757d);
  margin-bottom: 1rem;
}

.audio-info-bar i {
  color: var(--global-theme-color, #0d6efd);
  font-size: 0.875rem;
}

/* Controls Row */
.audio-controls-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.875rem;
  flex-wrap: wrap;
}

.audio-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.375rem 0.875rem;
  border: 1px solid transparent;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: inherit;
  color: #ffffff;
}

.audio-btn i {
  font-size: 0.8125rem;
}
.audio-btn span {
  color: #fff;
}
    

.audio-btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 0.125rem 0.375rem rgba(0, 0, 0, 0.15);
}

.audio-btn:active:not(:disabled) {
  transform: translateY(0);
}

.audio-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.audio-btn-play {
  background: var(--global-theme-color, #0d6efd);
  border-color: var(--global-theme-color, #0d6efd);
}

.audio-btn-play:hover:not(:disabled) {
  background: color-mix(in srgb, var(--global-theme-color, #0d6efd) 85%, black);
  border-color: color-mix(in srgb, var(--global-theme-color, #0d6efd) 80%, black);
}

.audio-btn-play.playing {
  background: #198754;
  border-color: #198754;
}

.audio-btn-pause {
  background: #6c757d;
  border-color: #6c757d;
}

.audio-btn-pause:hover:not(:disabled) {
  background: #5c636a;
  border-color: #565e64;
}

.audio-btn-stop {
  background: transparent;
  color: #dc3545;
  border-color: #dc3545;
  padding: 0.375rem 0.625rem;
}

.audio-btn-stop:hover:not(:disabled) {
  background: #dc3545;
  color: #ffffff;
  border-color: #dc3545;
}

/* Speed Control */
.audio-speed-control {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-left: auto;
}

.audio-speed-label {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  font-size: 0.8125rem;
  font-weight: 500;
  color: var(--global-text-color, #212529);
  margin: 0;
  white-space: nowrap;
}

.audio-speed-label i {
  color: var(--global-theme-color, #0d6efd);
  font-size: 0.875rem;
}

.audio-speed-slider {
  width: 80px;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--global-divider-color, #dee2e6);
  border-radius: 2px;
  outline: none;
}

.audio-speed-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--global-theme-color, #0d6efd);
  cursor: pointer;
  transition: transform 0.15s ease;
}

.audio-speed-slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
}

.audio-speed-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--global-theme-color, #0d6efd);
  border: none;
  cursor: pointer;
  transition: transform 0.15s ease;
}

.audio-speed-slider::-moz-range-thumb:hover {
  transform: scale(1.2);
}

/* Voice Row */
.audio-voice-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.875rem;
}

.audio-voice-label {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  font-size: 0.8125rem;
  font-weight: 500;
  color: var(--global-text-color, #212529);
  margin: 0;
  white-space: nowrap;
}

.audio-voice-label i {
  color: var(--global-theme-color, #0d6efd);
  font-size: 0.875rem;
}

.audio-voice-select {
  flex: 1;
  padding: 0.375rem 0.75rem;
  border: 1px solid var(--global-divider-color, #dee2e6);
  border-radius: 0.375rem;
  font-size: 0.8125rem;
  background: var(--global-bg-color, #ffffff);
  color: var(--global-text-color, #212529);
  cursor: pointer;
  transition: border-color 0.15s ease;
}

.audio-voice-select:hover {
  border-color: var(--global-theme-color, #0d6efd);
}

.audio-voice-select:focus {
  outline: none;
  border-color: var(--global-theme-color, #0d6efd);
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Progress Section */
.audio-progress-section {
  margin-top: 0.75rem;
  padding-top: 0.75rem;
  border-top: 1px solid var(--global-divider-color, #e9ecef);
}

.audio-progress-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.8125rem;
  color: var(--global-text-color-light, #6c757d);
  margin-bottom: 0.5rem;
}

.audio-progress-info i {
  margin-right: 0.25rem;
  color: var(--global-theme-color, #0d6efd);
  font-size: 0.75rem;
}

.progress {
  border-radius: 2px;
  overflow: hidden;
  background: var(--global-divider-color, #e9ecef);
}

.progress-bar {
  background: var(--global-theme-color, #0d6efd);
  transition: width 0.6s ease;
}

/* Dark Mode */
[data-theme="dark"] .audio-trigger,
body.dark-mode .audio-trigger {
  background: rgba(255, 255, 255, 0.05);
  border-color: var(--global-divider-color, #454545);
  color: var(--global-text-color, #e9ecef);
}

[data-theme="dark"] .audio-trigger:hover,
body.dark-mode .audio-trigger:hover {
  background: rgba(255, 255, 255, 0.08);
}

[data-theme="dark"] .audio-player-expanded,
body.dark-mode .audio-player-expanded {
  background: var(--global-bg-color, #1e1e1e);
  border-color: var(--global-divider-color, #454545);
}

[data-theme="dark"] .audio-info-bar,
body.dark-mode .audio-info-bar {
  background: rgba(255, 255, 255, 0.03);
}

[data-theme="dark"] .audio-voice-select,
body.dark-mode .audio-voice-select {
  background: var(--global-bg-color, #1e1e1e);
  border-color: var(--global-divider-color, #454545);
  color: var(--global-text-color, #e9ecef);
}

[data-theme="dark"] .progress,
body.dark-mode .progress {
  background: rgba(255, 255, 255, 0.1);
}

/* Mobile Responsive */
@media (max-width: 576px) {
  .audio-trigger span {
    display: none;
  }
  
  .audio-controls-row {
    flex-wrap: wrap;
  }
  
  .audio-btn span {
    display: none;
  }
  
  
  .audio-btn {
    padding: 0.5rem 0.75rem;
  }
  
  .audio-btn i {
    font-size: 1rem;
  }
  
  .audio-speed-control {
    width: 100%;
    margin-left: 0;
    margin-top: 0.5rem;
  }
  
  .audio-speed-slider {
    flex: 1;
  }
  
  .audio-voice-row {
    flex-direction: column;
    align-items: stretch;
  }
}

/* Print */
@media print {
  .audio-reader-container {
    display: none !important;
  }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
  .audio-trigger,
  .audio-btn,
  .progress-bar,
  .audio-player-expanded {
    transition: none;
    animation: none;
  }
}
</style>

<script>
(function() {
  'use strict';
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  function init() {
    if (!('speechSynthesis' in window)) {
      document.querySelector('.audio-reader-container').innerHTML = `
        <div class="audio-reader-compact">
          <div class="alert alert-warning d-flex align-items-center" role="alert" style="font-size: 0.875rem;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>Text-to-speech not supported in this browser.</div>
          </div>
        </div>
      `;
      return;
    }

    const synth = window.speechSynthesis;
    let utterance = null;
    let isPaused = false;
    
    const triggerBtn = document.getElementById('audio-trigger');
    const expandedPlayer = document.getElementById('audio-player-expanded');
    const playBtn = document.getElementById('tts-play');
    const pauseBtn = document.getElementById('tts-pause');
    const stopBtn = document.getElementById('tts-stop');
    const voiceSelect = document.getElementById('tts-voice');
    const rateSlider = document.getElementById('tts-rate');
    const rateValue = document.getElementById('tts-rate-value');
    const progressText = document.getElementById('tts-progress');
    const progressBar = document.getElementById('tts-progress-bar');
    const playText = document.getElementById('play-text');

    const possibleSelectors = [
      '.post-content',
      'article .post-content',
      '.post .post-content',
      'article.post',
      '.post',
      'article',
      'main article',
      'main .container',
      'main',
      '.l-main',
      '.content'
    ];
    
    let articleElement = null;
    for (const selector of possibleSelectors) {
      articleElement = document.querySelector(selector);
      if (articleElement) break;
    }
    
    if (!articleElement) {
      console.warn('Audio Reader: Could not find article content');
      return;
    }
    
    const clonedContent = articleElement.cloneNode(true);
    const elementsToRemove = [
      'pre', 'code', 'script', 'style', 'nav', '.audio-reader-container',
      '.citation', '.giscus', '.utterances', '.navigation', '.pagination',
      '.social', '.share', 'header', 'footer', '.header', '.footer', '.sidebar'
    ];
    
    elementsToRemove.forEach(selector => {
      clonedContent.querySelectorAll(selector).forEach(el => el.remove());
    });
    
    const articleText = clonedContent.innerText
      .replace(/\s+/g, ' ')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
    
    if (!articleText || articleText.length < 100) {
      console.warn('Audio Reader: Article too short');
      return;
    }

    // Toggle player
    triggerBtn.addEventListener('click', function() {
      expandedPlayer.classList.toggle('show');
      this.classList.toggle('active');
      localStorage.setItem('audioPlayerExpanded', expandedPlayer.classList.contains('show'));
    });

    // Load voices
    function loadVoices() {
      const voices = synth.getVoices();
      if (voices.length === 0) {
        setTimeout(loadVoices, 100);
        return;
      }
      
      voiceSelect.innerHTML = '<option value="">Default Voice</option>';
      
      const englishVoices = voices.filter(v => v.lang.startsWith('en'));
      const preferredVoices = englishVoices.filter(v => 
        v.name.includes('Google') || v.name.includes('Microsoft') ||
        v.name.includes('Premium') || v.name.includes('Enhanced') || v.name.includes('Natural')
      );
      const standardEnglishVoices = englishVoices.filter(v => !preferredVoices.includes(v));
      const otherVoices = voices.filter(v => !v.lang.startsWith('en'));
      
      preferredVoices.forEach((voice) => {
        const option = document.createElement('option');
        option.value = voices.indexOf(voice);
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);
      });
      
      if (standardEnglishVoices.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Other English';
        standardEnglishVoices.forEach((voice) => {
          const option = document.createElement('option');
          option.value = voices.indexOf(voice);
          option.textContent = `${voice.name} (${voice.lang})`;
          optgroup.appendChild(option);
        });
        voiceSelect.appendChild(optgroup);
      }
      
      if (otherVoices.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Other Languages';
        otherVoices.forEach((voice) => {
          const option = document.createElement('option');
          option.value = voices.indexOf(voice);
          option.textContent = `${voice.name} (${voice.lang})`;
          optgroup.appendChild(option);
        });
        voiceSelect.appendChild(optgroup);
      }
    }

    loadVoices();
    if (synth.addEventListener) {
      synth.addEventListener('voiceschanged', loadVoices);
    }

    function updateProgress(current, total) {
      const percent = Math.min(100, Math.round((current / total) * 100));
      progressText.textContent = `${percent}%`;
      progressBar.style.width = `${percent}%`;
      progressBar.setAttribute('aria-valuenow', percent);
    }

    function updatePlayButton(isPlaying) {
      const icon = playBtn.querySelector('i');
      if (isPlaying) {
        icon.className = 'fas fa-circle-dot';
        playText.textContent = 'Playing';
        playBtn.classList.add('playing');
      } else {
        icon.className = 'fas fa-play';
        playText.textContent = 'Play';
        playBtn.classList.remove('playing');
      }
    }

    function speak() {
      if (isPaused) {
        synth.resume();
        isPaused = false;
        updatePlayButton(true);
        pauseBtn.style.display = 'inline-flex';
        return;
      }

      synth.cancel();
      utterance = new SpeechSynthesisUtterance(articleText);
      
      if (voiceSelect.value) {
        const voices = synth.getVoices();
        utterance.voice = voices[parseInt(voiceSelect.value)];
      }
      
      utterance.rate = parseFloat(rateSlider.value);
      utterance.pitch = 1;
      utterance.volume = 1;
      
      utterance.onstart = function() {
        updatePlayButton(true);
        pauseBtn.style.display = 'inline-flex';
        playBtn.disabled = false;
      };
      
      utterance.onend = function() {
        updatePlayButton(false);
        pauseBtn.style.display = 'none';
        updateProgress(100, 100);
        setTimeout(() => updateProgress(0, 100), 1000);
      };
      
      utterance.onboundary = function(event) {
        updateProgress(event.charIndex, articleText.length);
      };

      utterance.onerror = function(event) {
        if (event.error !== 'interrupted' && event.error !== 'canceled') {
          alert('Playback error. Try a different voice.');
        }
        updatePlayButton(false);
        pauseBtn.style.display = 'none';
      };

      playBtn.disabled = true;
      synth.speak(utterance);
    }

    function pause() {
      if (synth.speaking && !isPaused) {
        synth.pause();
        isPaused = true;
        const icon = playBtn.querySelector('i');
        icon.className = 'fas fa-play';
        playText.textContent = 'Resume';
        playBtn.classList.remove('playing');
        pauseBtn.style.display = 'none';
      }
    }

    function stop() {
      synth.cancel();
      isPaused = false;
      updatePlayButton(false);
      pauseBtn.style.display = 'none';
      updateProgress(0, 100);
    }

    playBtn.addEventListener('click', speak);
    pauseBtn.addEventListener('click', pause);
    stopBtn.addEventListener('click', stop);
    
    rateSlider.addEventListener('input', function(e) {
      rateValue.textContent = `${parseFloat(e.target.value).toFixed(1)}x`;
    });

    window.addEventListener('beforeunload', function() {
      synth.cancel();
    });

    if (localStorage.getItem('audioPlayerExpanded') === 'true') {
      setTimeout(() => {
        expandedPlayer.classList.add('show');
        triggerBtn.classList.add('active');
      }, 100);
    }
  }
})();
</script>
{% endif %}